<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–º–µ–π–∫–∞ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ä–µ–∫–æ—Ä–¥–æ–≤</title>
  <style>
    body {
      background: #222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    #game-container {
      text-align: center;
    }
    #game {
      background: #111;
      box-shadow: 0 0 20px #000a;
      border: 2px solid #444;
      display: block;
      margin: 0 auto;
    }
    .score {
      color: #fff;
      font-size: 1.5em;
      margin: 10px 0;
    }
    #settings {
      text-align: center;
      margin-bottom: 20px;
      color: white;
    }
    #settings label {
      margin: 0 10px;
    }
    #leaderboard {
      color: white;
      margin-top: 20px;
      text-align: left;
      display: inline-block;
    }
    #leaderboard h3 {
      text-align: center;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    #leaderboard div {
      margin: 5px 0;
    }
    button {
      background: #444;
      color: white;
      border: none;
      padding: 8px 15px;
      margin: 5px;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover {
      background: #555;
    }
    input, select {
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #444;
    }
  </style>
</head>
<body>
<div id="game-container">
  <div class="score" id="player"></div>
  <div class="score" id="score">–°—á—ë—Ç: 0</div>
  <div id="settings">
    <label>–¶–≤–µ—Ç –∑–º–µ–π–∫–∏: <input type="color" id="snakeColor" value="#00ff00"></label>
    <label>–¶–≤–µ—Ç –ø–æ–ª—è: <input type="color" id="fieldColor" value="#111111"></label>
    <label>–°–ª–æ–∂–Ω–æ—Å—Ç—å:
      <select id="difficulty">
        <option value="easy">–õ—ë–≥–∫–∏–π</option>
        <option value="medium" selected>–°—Ä–µ–¥–Ω–∏–π</option>
        <option value="hard">–°–ª–æ–∂–Ω—ã–π</option>
      </select>
    </label>
    <label>–ú—É–∑—ã–∫–∞:
      <select id="musicSelect">
        <option value="0" selected>–í—ã–∫–ª</option>
        <option value="1">loading_theme</option>
        <option value="2">battle5</option>
        <option value="3">stealth1</option>
        <option value="4">belaya_noch_ch</option>
        <option value="5">kukushka</option>
        <option value="6">pachka_sigaret</option>
        <option value="7">dorm</option>
      </select>
    </label>
    <button id="toggleMusic" title="–í–∫–ª/–í—ã–∫–ª –∑–≤—É–∫">üîä</button>
    <input type="range" id="volumeControl" min="0" max="1" step="0.1" value="0.7" title="–ì—Ä–æ–º–∫–æ—Å—Ç—å">
    <button id="startBtn">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
    <button id="saveBtn" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</button>
  </div>
  <canvas id="game" width="400" height="400"></canvas>

  <div id="leaderboard">
    <h3>–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–∫–æ—Ä–¥–æ–≤</h3>
    <div id="records-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<script>
  // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è API
  const API_BASE_URL = 'http://localhost:8080/api/records'; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL API

  // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const box = 20;
  const canvasSize = 400;
  let snake = [{x: 9 * box, y: 10 * box}];
  let direction = null;
  let food = randomPosition();
  let score = 0;
  let gameInterval;
  let playerName = '';
  let snakeColor = '#00ff00';
  let fieldColor = '#111';
  let gameStarted = false;
  let difficulty = 'medium';
  let speedMap = { easy: 300, medium: 200, hard: 50 };
  let volume = 0.7;

  // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∏–≥–∞—Ä–µ—Ç—ã –¥–ª—è –µ–¥—ã
  const foodImg = new Image();
  foodImg.src = 'sig.png';

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º—É–∑—ã–∫–∏
  const musicTracks = {
    0: null,
    1: 'bgm/loading_theme.mp3',
    2: 'bgm/battle5.mp3',
    3: 'bgm/stealth1.mp3',
    4: 'bgm/belaya_noch_ch.mp3',
    5: 'bgm/kukushka.mp3',
    6: 'bgm/pachka_sigaret.mp3',
    7: 'bgm/dorm.mp3'
  };
  const bgMusic = new Audio();
  let currentTrack = 1;
  bgMusic.volume = volume;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  document.addEventListener('DOMContentLoaded', () => {
    showGreeting();
    draw();
    loadLeaderboard();
    setupEventListeners();
  });

  // –§—É–Ω–∫—Ü–∏–∏ API
  async function saveRecord() {
    const recordData = {
      nickname: playerName,
      record: score,
      volume: volume,
      color: snakeColor,
      background_color: fieldColor,
      difficulty: difficulty
    };

    try {
      const response = await fetch(API_BASE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(recordData)
      });

      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∫–æ—Ä–¥–∞');
      }

      const result = await response.json();
      console.log('–†–µ–∫–æ—Ä–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω:', result);
      alert('–†–µ–∫–æ—Ä–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
      loadLeaderboard();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∫–æ—Ä–¥: ' + error.message);
    }
  }

  async function loadLeaderboard() {
    try {
      const response = await fetch(API_BASE_URL + '/top/10');
      if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —Ä–µ–∫–æ—Ä–¥–æ–≤');
      }

      const records = await response.json();
      displayLeaderboard(records);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞:', error);
      document.getElementById('records-list').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ—Ä–¥–æ–≤';
    }
  }

  function displayLeaderboard(records) {
    const recordsList = document.getElementById('records-list');

    if (records.length === 0) {
      recordsList.innerHTML = '–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ—Ä–¥–æ–≤';
      return;
    }

    let html = '';
    records.forEach((record, index) => {
      html += `
        <div>
          ${index + 1}. ${record.nickname}: ${record.record}
          (${getDifficultyName(record.difficulty)})
        </div>
      `;
    });

    recordsList.innerHTML = html;
  }

  function getDifficultyName(difficulty) {
    const names = {
      easy: '–õ—ë–≥–∫–∏–π',
      medium: '–°—Ä–µ–¥–Ω–∏–π',
      hard: '–°–ª–æ–∂–Ω—ã–π'
    };
    return names[difficulty] || difficulty;
  }

  // –ò–≥—Ä–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function setupEventListeners() {
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–≥—Ä–æ–π
    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft' && direction !== 'RIGHT') direction = 'LEFT';
      else if (e.key === 'ArrowUp' && direction !== 'DOWN') direction = 'UP';
      else if (e.key === 'ArrowRight' && direction !== 'LEFT') direction = 'RIGHT';
      else if (e.key === 'ArrowDown' && direction !== 'UP') direction = 'DOWN';
      else if (e.key === ' ' && !gameInterval) startGame();
    });

    // –ú—É–∑—ã–∫–∞
    document.getElementById('volumeControl').addEventListener('input', function() {
      volume = parseFloat(this.value);
      bgMusic.volume = volume;
      updateMusicButtonIcon();
    });

    document.getElementById('musicSelect').addEventListener('change', function() {
      currentTrack = parseInt(this.value);
      playMusic(currentTrack);
    });

    document.getElementById('toggleMusic').addEventListener('click', toggleMusic);

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã
    document.getElementById('snakeColor').addEventListener('input', function() {
      snakeColor = this.value;
      if (gameStarted) draw();
    });

    document.getElementById('fieldColor').addEventListener('input', function() {
      fieldColor = this.value;
      if (gameStarted) draw();
    });

    document.getElementById('difficulty').addEventListener('change', function() {
      difficulty = this.value;
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('startBtn').addEventListener('click', function() {
      snakeColor = document.getElementById('snakeColor').value;
      fieldColor = document.getElementById('fieldColor').value;
      difficulty = document.getElementById('difficulty').value;
      startGame();
    });

    document.getElementById('saveBtn').addEventListener('click', saveRecord);
  }

  function playMusic(trackNumber) {
    if (trackNumber === 0) {
      bgMusic.pause();
      return;
    }
    bgMusic.src = musicTracks[trackNumber];
    bgMusic.loop = true;
    bgMusic.play().catch(e => console.log("–ë—Ä–∞—É–∑–µ—Ä —Ç—Ä–µ–±—É–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è!"));
  }

  function toggleMusic() {
    if (bgMusic.paused || volume === 0) {
      if (volume === 0) {
        volume = 0.7;
        document.getElementById('volumeControl').value = volume;
      }
      bgMusic.volume = volume;
      playMusic(currentTrack);
    } else {
      bgMusic.pause();
    }
    updateMusicButtonIcon();
  }

  function updateMusicButtonIcon() {
    const icon = (bgMusic.paused || volume === 0) ? 'üîá' : 'üîä';
    document.getElementById('toggleMusic').textContent = icon;
  }

  function randomPosition() {
    const freeCells = [];
    for (let x = 0; x < canvasSize; x += box) {
      for (let y = 0; y < canvasSize; y += box) {
        if (!snake.some(segment => segment.x === x && segment.y === y)) {
          freeCells.push({x, y});
        }
      }
    }

    if (freeCells.length === 0) {
      clearInterval(gameInterval);
      gameInterval = null;
      alert('–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏! –í–∞—à —Å—á—ë—Ç: ' + score);
      document.getElementById('saveBtn').disabled = false;
      return {x: -box, y: -box};
    }

    return freeCells[Math.floor(Math.random() * freeCells.length)];
  }

  function showGreeting() {
    playerName = prompt('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –∏–≥—Ä—É –ó–º–µ–π–∫–∞!\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:', '–ò–≥—Ä–æ–∫');
    if (!playerName) playerName = '–ò–≥—Ä–æ–∫';
    document.getElementById('player').textContent = '–ò–≥—Ä–æ–∫: ' + playerName;
  }

  function draw() {
    ctx.fillStyle = fieldColor;
    ctx.fillRect(0, 0, canvasSize, canvasSize);

    // –†–∏—Å—É–µ–º –∑–º–µ–π–∫—É
    for (let i = 0; i < snake.length; i++) {
      ctx.fillStyle = i === 0 ? snakeColor : shadeColor(snakeColor, -30);
      ctx.fillRect(snake[i].x, snake[i].y, box, box);
      ctx.strokeStyle = '#222';
      ctx.strokeRect(snake[i].x, snake[i].y, box, box);
    }

    // –†–∏—Å—É–µ–º –µ–¥—É (—Å–∏–≥–∞—Ä–µ—Ç—É)
    if (foodImg.complete) {
      ctx.drawImage(foodImg, food.x, food.y, box, box);
    } else {
      foodImg.onload = () => ctx.drawImage(foodImg, food.x, food.y, box, box);
    }

    document.getElementById('score').textContent = '–°—á—ë—Ç: ' + score;
  }

  function update() {
    let head = {x: snake[0].x, y: snake[0].y};
    if (direction === 'LEFT') head.x -= box;
    if (direction === 'RIGHT') head.x += box;
    if (direction === 'UP') head.y -= box;
    if (direction === 'DOWN') head.y += box;

    if (head.x < 0) head.x = canvasSize - box;
    if (head.x >= canvasSize) head.x = 0;
    if (head.y < 0) head.y = canvasSize - box;
    if (head.y >= canvasSize) head.y = 0;

    if (collision(head, snake)) {
      endGame();
      return;
    }

    if (head.x === food.x && head.y === food.y) {
      score++;
      food = randomPosition();
      if (food.x < 0 || food.y < 0) return;
    } else {
      snake.pop();
    }

    snake.unshift(head);
    draw();
  }

  function collision(head, arr) {
    for (let i = 1; i < arr.length; i++) {
      if (head.x === arr[i].x && head.y === arr[i].y) return true;
    }
    return false;
  }

  function startGame() {
    if (gameInterval) return;
    resetGame();
    direction = 'RIGHT';
    let speed = speedMap[difficulty] || 200;
    gameInterval = setInterval(update, speed);
    gameStarted = true;
    document.getElementById('saveBtn').disabled = true;
  }

  function endGame() {
    clearInterval(gameInterval);
    gameInterval = null;
    alert('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í–∞—à —Å—á—ë—Ç: ' + score);
    document.getElementById('saveBtn').disabled = false;
  }

  function resetGame() {
    snake = [{x: 9 * box, y: 10 * box}];
    direction = null;
    food = randomPosition();
    score = 0;
    draw();
  }

  function shadeColor(color, percent) {
    let R = parseInt(color.substring(1,3),16);
    let G = parseInt(color.substring(3,5),16);
    let B = parseInt(color.substring(5,7),16);
    R = parseInt(R * (100 + percent) / 100);
    G = parseInt(G * (100 + percent) / 100);
    B = parseInt(B * (100 + percent) / 100);
    R = (R<255)?R:255;  G = (G<255)?G:255;  B = (B<255)?B:255;
    let RR = ((R.toString(16).length==1)?"0":"") + R.toString(16);
    let GG = ((G.toString(16).length==1)?"0":"") + G.toString(16);
    let BB = ((B.toString(16).length==1)?"0":"") + B.toString(16);
    return "#"+RR+GG+BB;
  }
</script>
</body>
</html>